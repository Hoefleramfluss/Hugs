# Defines CI/CD workflow: install deps, run tests, build/push images, migrate DB, deploy to Cloud Run, run smoke tests.
steps:
  - name: 'gcr.io/cloud-builders/npm'
    id: 'Install dependencies'
    args: ['ci']

  - name: 'gcr.io/cloud-builders/npm'
    id: 'Run backend tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "${_DEPLOY_TARGET}" == "frontend" ]]; then
          echo 'Skipping backend tests for frontend-only deployment';
          exit 0;
        fi
        npm run test --workspace=backend -- --runInBand

  - name: 'gcr.io/cloud-builders/npm'
    id: 'Build frontend (SSG check)'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'NEXT_PUBLIC_API_URL="${_NEXT_PUBLIC_API_URL}" ./ci/check_frontend_build.sh'

  - name: 'mcr.microsoft.com/playwright:v1.45.1-focal'
    id: 'Run frontend smoke tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        npm config set fund false
        npm config set audit false
        npm install --include-workspace-root --workspace=frontend
        NEXT_PUBLIC_API_URL="${_NEXT_PUBLIC_API_URL}" npm run test:e2e --workspace=frontend -- --project=chromium

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build backend image'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "${_DEPLOY_TARGET}" == "frontend" ]]; then
          echo 'Skipping backend image build';
          exit 0;
        fi
        docker build -t "${_GCP_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/backend:${COMMIT_SHA}" .

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build frontend image'
    args:
      - 'build'
      - '-f'
      - 'frontend/Dockerfile'
      - '-t'
      - '${_GCP_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:$COMMIT_SHA'
      - '--build-arg'
      - 'NEXT_PUBLIC_API_URL=${_NEXT_PUBLIC_API_URL}'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push backend image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "${_DEPLOY_TARGET}" == "frontend" ]]; then
          echo 'Skipping backend image push';
          exit 0;
        fi
        docker push "${_GCP_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/backend:${COMMIT_SHA}"

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push frontend image'
    args: ['push', '${_GCP_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:$COMMIT_SHA']

  - name: 'gcr.io/google-appengine/exec-wrapper'
    id: 'Run Prisma migrations'
    args:
      - '-i'
      - 'node:20'
      - '-s'
      - '${_DB_CONNECTION_NAME}'
      - '-e'
      - 'DATABASE_URL'
      - '--'
      - 'bash'
      - '-lc'
      - 'if [[ "${_DEPLOY_TARGET}" == "frontend" ]]; then echo "Skipping Prisma migrations"; exit 0; fi; cd /workspace/backend && npx prisma migrate deploy'
    secretEnv: ['DATABASE_URL']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy backend service'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "${_DEPLOY_TARGET}" == "frontend" ]]; then
          echo 'Skipping backend deployment';
          exit 0;
        fi
        gcloud run deploy "hugs-backend-${_ENV}" \
          --image="${_GCP_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/backend:${COMMIT_SHA}" \
          --region="${_GCP_REGION}" \
          --platform=managed \
          --quiet \
          --service-account="${_CLOUD_RUN_SA}" \
          --add-cloudsql-instances="${_DB_CONNECTION_NAME}" \
          --set-secrets="JWT_SECRET=jwt-secret:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,POS_API_KEY=pos-api-key:latest,API_KEY=gemini-api-key:latest,DATABASE_URL=database-url:latest" \
          --allow-unauthenticated

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy frontend service'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'hugs-frontend-${_ENV}'
      - '--image=${_GCP_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:$COMMIT_SHA'
      - '--region=${_GCP_REGION}'
      - '--platform=managed'
      - '--quiet'
      - '--service-account=${_CLOUD_RUN_SA}'
      - '--allow-unauthenticated'
      - '--set-env-vars=NEXT_PUBLIC_API_URL=${_NEXT_PUBLIC_API_URL}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Smoke test services'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "${_DEPLOY_TARGET:-all}" == "frontend" ]]; then
          echo 'Skipping smoke tests for backend services';
          exit 0;
        fi
        set -euo pipefail
        BACKEND_URL=$$(gcloud run services describe "hugs-backend-${_ENV}" --platform managed --region ${_GCP_REGION} --format='value(status.url)')
        FRONTEND_URL=$$(gcloud run services describe "hugs-frontend-${_ENV}" --platform managed --region ${_GCP_REGION} --format='value(status.url)')
        BACKEND_URL="$$BACKEND_URL" FRONTEND_URL="$$FRONTEND_URL" bash ci/check_post_deploy.sh

substitutions:
  _GCP_REGION: 'europe-west3'
  _ARTIFACT_REPO: 'hugs-headshop-repo'
  _ENV: 'prod'
  _DB_CONNECTION_NAME: 'hugs-headshop-20251108122937:europe-west3:hugs-pg-instance-prod'
  _CLOUD_RUN_SA: 'hugs-cloud-run-sa@hugs-headshop-20251108122937.iam.gserviceaccount.com'
  _NEXT_PUBLIC_API_URL: 'https://hugs-backend-prod-787273457651.europe-west3.run.app'
  _DEPLOY_TARGET: 'all'

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/database-url/versions/latest
      env: 'DATABASE_URL'

images:
  - '${_GCP_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/backend:$COMMIT_SHA'
  - '${_GCP_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:$COMMIT_SHA'
