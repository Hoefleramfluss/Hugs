# Cloud Build job to run Prisma migrations against Cloud SQL using Auth Proxy.
steps:
  - name: 'gcr.io/google-appengine/exec-wrapper'
    args:
      - '-i'
      - 'node:20'
      - '-s'
      - '${_DB_CONNECTION_NAME}'
      - '-e'
      - 'DATABASE_URL'
      - '--'
      - 'bash'
      - '-lc'
      - |
          set -euo pipefail
          cd /workspace/backend
          npx prisma migrate deploy --schema=prisma/schema.prisma
    env:
      - 'CLOUD_SQL_PROXY_ARGS=--private-ip'
    secretEnv: ['DATABASE_URL']

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/database-url/versions/latest
      env: 'DATABASE_URL'
